(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[1140],{3905:function(e,n,t){"use strict";t.d(n,{Zo:function(){return c},kt:function(){return m}});var r=t(7294);function a(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function i(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?i(Object(t),!0).forEach((function(n){a(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,r,a=function(e,n){if(null==e)return{};var t,r,a={},i=Object.keys(e);for(r=0;r<i.length;r++)t=i[r],n.indexOf(t)>=0||(a[t]=e[t]);return a}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)t=i[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(a[t]=e[t])}return a}var s=r.createContext({}),p=function(e){var n=r.useContext(s),t=n;return e&&(t="function"==typeof e?e(n):o(o({},n),e)),t},c=function(e){var n=p(e.components);return r.createElement(s.Provider,{value:n},e.children)},d={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},u=r.forwardRef((function(e,n){var t=e.components,a=e.mdxType,i=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),u=p(t),m=a,h=u["".concat(s,".").concat(m)]||u[m]||d[m]||i;return t?r.createElement(h,o(o({ref:n},c),{},{components:t})):r.createElement(h,o({ref:n},c))}));function m(e,n){var t=arguments,a=n&&n.mdxType;if("string"==typeof e||a){var i=t.length,o=new Array(i);o[0]=u;var l={};for(var s in n)hasOwnProperty.call(n,s)&&(l[s]=n[s]);l.originalType=e,l.mdxType="string"==typeof e?e:a,o[1]=l;for(var p=2;p<i;p++)o[p]=t[p];return r.createElement.apply(null,o)}return r.createElement.apply(null,t)}u.displayName="MDXCreateElement"},9078:function(e,n,t){"use strict";t.r(n),t.d(n,{frontMatter:function(){return o},metadata:function(){return l},toc:function(){return s},default:function(){return c}});var r=t(2122),a=t(9756),i=(t(7294),t(3905)),o={},l={unversionedId:"examples/bart",id:"examples/bart",isDocsHomePage:!1,title:"Bart Summarization",description:"Krishan Subudhi",source:"@site/docs/examples/bart.md",sourceDirName:"examples",slug:"/examples/bart",permalink:"/PyMarlin/docs/examples/bart",editUrl:"https://github.com/microsoft/PyMarlin/edit/master/website/docs/examples/bart.md",version:"current",frontMatter:{},sidebar:"docsSidebar",previous:{title:"PyMarlin in Pictures",permalink:"/PyMarlin/docs/marlin-in-pictures"},next:{title:"CIFAR image classification",permalink:"/PyMarlin/docs/examples/cifar"}},s=[{value:"1. Download Data",id:"1-download-data",children:[]},{value:"2. Preprocess and analyze",id:"2-preprocess-and-analyze",children:[]},{value:"3. Train",id:"3-train",children:[]},{value:"1. Setup VM environment",id:"1-setup-vm-environment",children:[]},{value:"2. Transfer code form local machine to VM",id:"2-transfer-code-form-local-machine-to-vm",children:[]},{value:"3. Install pymarlin and requirements",id:"3-install-pymarlin-and-requirements",children:[]},{value:"4. Downlaod data",id:"4-downlaod-data",children:[]},{value:"5. Analyze Data",id:"5-analyze-data",children:[]},{value:"6. Train",id:"6-train",children:[{value:"Train for few more steps",id:"train-for-few-more-steps",children:[]},{value:"Run production config",id:"run-production-config",children:[]}]},{value:"7. Distributed Training",id:"7-distributed-training",children:[]},{value:"8. Start tensorboard in VM",id:"8-start-tensorboard-in-vm",children:[]}],p={toc:s};function c(e){var n=e.components,o=(0,a.Z)(e,["components"]);return(0,i.kt)("wrapper",(0,r.Z)({},p,o,{components:n,mdxType:"MDXLayout"}),(0,i.kt)("p",null,"Krishan Subudhi"),(0,i.kt)("hr",null),(0,i.kt)("p",null,"This is an example explaining entire pipe line for a summarization task using pymarlin library."),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"https://github.com/microsoft/PyMarlin/tree/main/examples/bart"},"Source code location")),(0,i.kt)("p",null,"Dataset used: CNN Daily mail"),(0,i.kt)("p",null,"BART Paper : ",(0,i.kt)("a",{parentName:"p",href:"https://arxiv.org/abs/1910.13461"},"BART")),(0,i.kt)("p",null,"We start with a pretrained checkpoint from huggingface and finetune on CNN dailymail data. "),(0,i.kt)("p",null,"Huggingface Bart model documantation: ",(0,i.kt)("a",{parentName:"p",href:"https://huggingface.co/transformers/model_doc/bart.html"},"https://huggingface.co/transformers/model_doc/bart.html")),(0,i.kt)("h1",{id:"local-machine"},"Local Machine"),(0,i.kt)("h2",{id:"1-download-data"},"1. Download Data"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"wget https://cdn-datasets.huggingface.co/summarization/cnn_dm_v2.tgz -UseBasicParsing\n\ndir 'C:/Users/krkusuk/Downloads/'\n\ntar -xzvf 'C:/Users/krkusuk/Downloads/cnn_dm_v2.tgz'  # empty lines removed\n\nmv 'cnn_cln' 'D:/data'\n\ndir 'D:/data/cnn_cln'\n")),(0,i.kt)("h2",{id:"2-preprocess-and-analyze"},"2. Preprocess and analyze"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"python data.py 'D:/data/cnn_cln'\n")),(0,i.kt)("h2",{id:"3-train"},"3. Train"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"python train.py --data_path D:/data/cnn_cln\n")),(0,i.kt)("h1",{id:"gpu-vm"},"GPU VM"),(0,i.kt)("p",null,"Boot a DSVM in azure with V100 GPUs. Enable ssh access by entering your public SSH key during booting.\nCreate these environment variables in your local machine for easy login."),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"$user : username of the VM"),(0,i.kt)("li",{parentName:"ul"},"$machine : machine IP"),(0,i.kt)("li",{parentName:"ul"},"$port : SSH port")),(0,i.kt)("h2",{id:"1-setup-vm-environment"},"1. Setup VM environment"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"ssh $user@$machine -p $port\nbash\nwget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh\nbash Miniconda3-latest-Linux-x86_64.sh -y\n")),(0,i.kt)("p",null,"restart shell"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"nvidia-smi\nconda create -n pymarlin python=3.8 -y\nconda activate pymarlin\nconda install pytorch cudatoolkit=10.2 -c pytorch -y # make sure cuda version is same as nvidia-smi\nmkdir PyMarlin\n")),(0,i.kt)("h2",{id:"2-transfer-code-form-local-machine-to-vm"},"2. Transfer code form local machine to VM"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"scp -P $port -r C:\\Users\\krkusuk\\repos\\PyMarlin\\pymarlin $user@${machine}:/home/$user/PyMarlin/pymarlin\nscp -P $port -r C:\\Users\\krkusuk\\repos\\PyMarlin\\setup.py  $user@${machine}:/home/$user/PyMarlin\nscp -P $port -r C:\\Users\\krkusuk\\repos\\PyMarlin\\README.md  $user@${machine}:/home/$user/PyMarlin\nscp -P $port -r C:\\Users\\krkusuk\\repos\\PyMarlin\\examples\\bart $user@${machine}:/home/$user\\PyMarlin\\bart \n")),(0,i.kt)("h2",{id:"3-install-pymarlin-and-requirements"},"3. Install pymarlin and requirements"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"> ssh $user@$machine -p $port\n$ conda activate pymarlin\n$ pip install  ./PyMarlin --force-reinstall\n\nor\n\n$ export PYTHONPATH=~/PyMarlin/\n")),(0,i.kt)("h2",{id:"4-downlaod-data"},"4. Downlaod data"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"$ wget https://cdn-datasets.huggingface.co/summarization/cnn_dm_v2.tgz\ntar -xzvf cnn_dm_v2.tgz\ncd PyMarlin/bart\n")),(0,i.kt)("h2",{id:"5-analyze-data"},"5. Analyze Data"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'    python data.py  ~/cnn_cln\n    \n    **** Analyzing Train ***\n                                          source\n            target\n    0  Editor\'s note: In our Behind the Scenes series...  Mentally ill inmates in Miami are housed on th...\n    1  LONDON, England (Reuters) -- Harry Potter star...  Harry Potter star Daniel Radcliffe gets \xa320M f...\n    2  MINNEAPOLIS, Minnesota (CNN) -- Drivers who we...  NEW: "I thought I was going to die," driver sa...\n    3  BAGHDAD, Iraq (CNN) -- Dressed in a Superman s...  Parents beam with pride, can\'t stop from smili...\n    4  WASHINGTON (CNN) -- Doctors removed five small...  Five small polyps found during procedure; "non...\n\n    Word length analysis:\n                source         target\n    count  287112.000000  287112.000000\n    mean      691.873032      51.573752\n    std       336.498413      21.255547\n    min        18.000000       4.000000\n    25%       443.000000      38.000000\n    50%       632.000000      48.000000\n    75%       877.000000      60.000000\n    max      2347.000000    1296.000000\n\n    **** Analyzing Val ***\n                                                source\n                    target\n    0  (CNN)The only thing crazier than a guy in snow...  A man in suburban Boston is selling snow onlin...\n    1  (CNN)On the 6th of April 1996, San Jose Clash ...  The 20th MLS season begins this weekend . Leag...\n    2  (CNN)French striker Bafetimbi Gomis, who has a...  Bafetimbi Gomis collapses within 10 minutes of...\n    3  (CNN)My vote for Father of the Year goes to Cu...  Ruben Navarrette: Schilling deserves praise fo...\n    4  (CNN)It was an act of frustration perhaps more...  Rory McIlroy throws club into water at WGC Cad...\n\n    Word length analysis:\n                source        target\n    count  13368.000000  13368.000000\n    mean     676.026406     57.910084\n    std      343.557667     25.613557\n    min       41.000000     10.000000\n    25%      413.750000     41.000000\n    50%      608.000000     54.000000\n    75%      868.000000     69.000000\n    max     1917.000000   1440.000000\n')),(0,i.kt)("h2",{id:"6-train"},"6. Train"),(0,i.kt)("p",null,"The 75 percentile length for source text is 877 and 60 for target text. The sequence length after tokenization will also increase further. BART was pretrained with positional embedding upto 1024. We will use 1024 length for source and 128 for target. This value can be tuned further for better performance."),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"config.yaml")," contains code which runs only for few steps to check if everything is OK. Run it to verify the correctness of the code and test the environment setup. This can also be run with CPU to do sanity test before moving code to GPU or running in AML."),(0,i.kt)("h3",{id:"train-for-few-more-steps"},"Train for few more steps"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"$ python data.py ~/cnn_cln # skip if ran previously\n$ python train.py --data_path ~/cnn_cln\n\n\n$ python train.py --data_path ~/cnn_cln --tmgr.max_train_steps_per_epoch 20 --tmgr.max_val_steps_per_epoch 20 --tmgr.epochs 3\n")),(0,i.kt)("h3",{id:"run-production-config"},"Run production config"),(0,i.kt)("h4",{id:"full-training-on-single-gpu"},"Full training on single GPU"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"python train.py --config_path config-prod.yaml --data_path ~/cnn_cln --dist False\n")),(0,i.kt)("p",null,"This will be really slow though. Use PyMarlin's distributed trainer to speed up training"),(0,i.kt)("h2",{id:"7-distributed-training"},"7. Distributed Training"),(0,i.kt)("p",null,"Test config"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"python -m torch.distributed.launch --nproc_per_node 4 train.py --data_path ~/cnn_cln --dist\n")),(0,i.kt)("p",null,"Prod config"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"nohup python -m torch.distributed.launch --nproc_per_node 4 train.py --config_path config-prod.yaml --data_path ~/cnn_cln --dist &> prod-logs-dist.txt\n\ntail -f  prod-logs-dist.txt\n")),(0,i.kt)("p",null,(0,i.kt)("em",{parentName:"p"},"Command to Kill all processes")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"ps |grep python | awk '{print $1}' | xargs -I% kill -9 %\n")),(0,i.kt)("h2",{id:"8-start-tensorboard-in-vm"},"8. Start tensorboard in VM"),(0,i.kt)("p",null,"In a separate shell,"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"$ tensorboard --logdir ~/PyMarlin/bart/logs.\n")),(0,i.kt)("p",null,"Tunnel tensorboard in local machine"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"# ssh -N -f -L 127.0.0.1:6006:127.0.0.1:6006  $user@${machine} -p $port\n")),(0,i.kt)("p",null,"Now open tensorboard: http://localhost:6006/#scalars\n",(0,i.kt)("img",{alt:"tensorboard screenshot",src:t(3276).Z})))}c.isMDXComponent=!0},3276:function(e,n,t){"use strict";n.Z=t.p+"assets/images/tensorboard_screenshot_bart-d573a18768da7ece0adb108f272ac5d7.jpg"}}]);