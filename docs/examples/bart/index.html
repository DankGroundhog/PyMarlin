<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.75">
<link rel="alternate" type="application/rss+xml" href="/PyMarlin/blog/rss.xml" title="PyMarlin Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/PyMarlin/blog/atom.xml" title="PyMarlin Blog Atom Feed"><title data-react-helmet="true">Bart Summarization | PyMarlin</title><meta data-react-helmet="true" property="og:url" content="https://github.com/microsoft/PyMarlin/PyMarlin/docs/examples/bart"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Bart Summarization | PyMarlin"><meta data-react-helmet="true" name="description" content="Krishan Subudhi"><meta data-react-helmet="true" property="og:description" content="Krishan Subudhi"><link data-react-helmet="true" rel="shortcut icon" href="/PyMarlin/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://github.com/microsoft/PyMarlin/PyMarlin/docs/examples/bart"><link data-react-helmet="true" rel="alternate" href="https://github.com/microsoft/PyMarlin/PyMarlin/docs/examples/bart" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://github.com/microsoft/PyMarlin/PyMarlin/docs/examples/bart" hreflang="x-default"><link rel="stylesheet" href="/PyMarlin/assets/css/styles.4339f032.css">
<link rel="preload" href="/PyMarlin/assets/js/runtime~main.7ee5d68a.js" as="script">
<link rel="preload" href="/PyMarlin/assets/js/main.412c625a.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/PyMarlin/"><img src="/PyMarlin/img/logo.svg" alt="My Site Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/PyMarlin/img/logo.svg" alt="My Site Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">PyMarlin</strong></a><a class="navbar__item navbar__link navbar__link--active" href="/PyMarlin/docs/getting-started">Docs</a><a class="navbar__item navbar__link" href="/PyMarlin/docs/reference/core/module_interface">SDK</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/microsoft/PyMarlin" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle displayOnlyInLargeViewport_GrZ2 react-toggle--disabled" role="button" tabindex="-1"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/PyMarlin/"><img src="/PyMarlin/img/logo.svg" alt="My Site Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/PyMarlin/img/logo.svg" alt="My Site Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">PyMarlin</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link navbar__link--active" href="/PyMarlin/docs/getting-started">Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/PyMarlin/docs/reference/core/module_interface">SDK</a></li><li class="menu__list-item"><a href="https://github.com/microsoft/PyMarlin" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_31aa"><div class="docSidebarContainer_3Kbt" role="complementary"><div class="sidebar_15mo"><div class="menu menu--responsive thin-scrollbar menu_Bmed"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_fgN0" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/PyMarlin/docs/getting-started">Getting Started</a></li><li class="menu__list-item"><a class="menu__link" href="/PyMarlin/docs/installation">Installation</a></li><li class="menu__list-item"><a class="menu__link" href="/PyMarlin/docs/marlin-in-pictures">PyMarlin in Pictures</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Examples</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/PyMarlin/docs/examples/azureml">Azure ML</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/PyMarlin/docs/examples/bart">Bart Summarization</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/PyMarlin/docs/examples/cifar">CIFAR image classification</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/PyMarlin/docs/examples/datamodule-example">Data interface single and multi process</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/PyMarlin/docs/examples/distillation">Distillation</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/PyMarlin/docs/examples/glue-tasks">Glue Tasks</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Plugins</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/PyMarlin/docs/plugins/hf_ner">Named Entity Recognition with HuggingFace models</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/PyMarlin/docs/plugins/hf_seq_classification">Text Sequence Classification with Huggingface models</a></li></ul></li><li class="menu__list-item"><a class="menu__link" href="/PyMarlin/docs/utils/stats">Stats and tensorboard</a></li><li class="menu__list-item"><a class="menu__link" href="/PyMarlin/docs/credits">Feedback &amp; Credits</a></li></ul></div></div></div><main class="docMainContainer_3ufF"><div class="container padding-vert--lg docItemWrapper_3FMP"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><header><h1 class="docTitle_3a4h">Bart Summarization</h1></header><div class="markdown"><p>Krishan Subudhi</p><hr><p>This is an example explaining entire pipe line for a summarization task using pymarlin library.</p><p><a href="https://github.com/microsoft/PyMarlin/tree/main/examples/bart" target="_blank" rel="noopener noreferrer">Source code location</a></p><p>Dataset used: CNN Daily mail</p><p>BART Paper : <a href="https://arxiv.org/abs/1910.13461" target="_blank" rel="noopener noreferrer">BART</a></p><p>We start with a pretrained checkpoint from huggingface and finetune on CNN dailymail data. </p><p>Huggingface Bart model documantation: <a href="https://huggingface.co/transformers/model_doc/bart.html" target="_blank" rel="noopener noreferrer">https://huggingface.co/transformers/model_doc/bart.html</a></p><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="local-machine"></a>Local Machine<a class="hash-link" href="#local-machine" title="Direct link to heading">#</a></h1><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="1-download-data"></a>1. Download Data<a class="hash-link" href="#1-download-data" title="Direct link to heading">#</a></h2><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">wget https://cdn-datasets.huggingface.co/summarization/cnn_dm_v2.tgz -UseBasicParsing</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">dir &#x27;C:/Users/krkusuk/Downloads/&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">tar -xzvf &#x27;C:/Users/krkusuk/Downloads/cnn_dm_v2.tgz&#x27;  # empty lines removed</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">mv &#x27;cnn_cln&#x27; &#x27;D:/data&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">dir &#x27;D:/data/cnn_cln&#x27;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="2-preprocess-and-analyze"></a>2. Preprocess and analyze<a class="hash-link" href="#2-preprocess-and-analyze" title="Direct link to heading">#</a></h2><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">python data.py &#x27;D:/data/cnn_cln&#x27;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="3-train"></a>3. Train<a class="hash-link" href="#3-train" title="Direct link to heading">#</a></h2><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">python train.py --data_path D:/data/cnn_cln</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="gpu-vm"></a>GPU VM<a class="hash-link" href="#gpu-vm" title="Direct link to heading">#</a></h1><p>Boot a DSVM in azure with V100 GPUs. Enable ssh access by entering your public SSH key during booting.
Create these environment variables in your local machine for easy login.</p><ul><li>$user : username of the VM</li><li>$machine : machine IP</li><li>$port : SSH port</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="1-setup-vm-environment"></a>1. Setup VM environment<a class="hash-link" href="#1-setup-vm-environment" title="Direct link to heading">#</a></h2><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">ssh $user@$machine -p $port</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">bash</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">bash Miniconda3-latest-Linux-x86_64.sh -y</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>restart shell</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">nvidia-smi</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">conda create -n pymarlin python=3.8 -y</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">conda activate pymarlin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">conda install pytorch cudatoolkit=10.2 -c pytorch -y # make sure cuda version is same as nvidia-smi</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">mkdir PyMarlin</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="2-transfer-code-form-local-machine-to-vm"></a>2. Transfer code form local machine to VM<a class="hash-link" href="#2-transfer-code-form-local-machine-to-vm" title="Direct link to heading">#</a></h2><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">scp -P $port -r C:\Users\krkusuk\repos\PyMarlin\pymarlin $user@${machine}:/home/$user/PyMarlin/pymarlin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">scp -P $port -r C:\Users\krkusuk\repos\PyMarlin\setup.py  $user@${machine}:/home/$user/PyMarlin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">scp -P $port -r C:\Users\krkusuk\repos\PyMarlin\README.md  $user@${machine}:/home/$user/PyMarlin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">scp -P $port -r C:\Users\krkusuk\repos\PyMarlin\examples\bart $user@${machine}:/home/$user\PyMarlin\bart </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="3-install-pymarlin-and-requirements"></a>3. Install pymarlin and requirements<a class="hash-link" href="#3-install-pymarlin-and-requirements" title="Direct link to heading">#</a></h2><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">&gt; ssh $user@$machine -p $port</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ conda activate pymarlin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ pip install  ./PyMarlin --force-reinstall</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">or</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ export PYTHONPATH=~/PyMarlin/</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="4-downlaod-data"></a>4. Downlaod data<a class="hash-link" href="#4-downlaod-data" title="Direct link to heading">#</a></h2><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ wget https://cdn-datasets.huggingface.co/summarization/cnn_dm_v2.tgz</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">tar -xzvf cnn_dm_v2.tgz</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cd PyMarlin/bart</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="5-analyze-data"></a>5. Analyze Data<a class="hash-link" href="#5-analyze-data" title="Direct link to heading">#</a></h2><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">    python data.py  ~/cnn_cln</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    **** Analyzing Train ***</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                          source</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            target</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    0  Editor&#x27;s note: In our Behind the Scenes series...  Mentally ill inmates in Miami are housed on th...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    1  LONDON, England (Reuters) -- Harry Potter star...  Harry Potter star Daniel Radcliffe gets Â£20M f...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    2  MINNEAPOLIS, Minnesota (CNN) -- Drivers who we...  NEW: &quot;I thought I was going to die,&quot; driver sa...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    3  BAGHDAD, Iraq (CNN) -- Dressed in a Superman s...  Parents beam with pride, can&#x27;t stop from smili...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    4  WASHINGTON (CNN) -- Doctors removed five small...  Five small polyps found during procedure; &quot;non...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Word length analysis:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                source         target</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    count  287112.000000  287112.000000</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    mean      691.873032      51.573752</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    std       336.498413      21.255547</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    min        18.000000       4.000000</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    25%       443.000000      38.000000</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    50%       632.000000      48.000000</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    75%       877.000000      60.000000</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    max      2347.000000    1296.000000</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    **** Analyzing Val ***</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                                source</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    target</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    0  (CNN)The only thing crazier than a guy in snow...  A man in suburban Boston is selling snow onlin...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    1  (CNN)On the 6th of April 1996, San Jose Clash ...  The 20th MLS season begins this weekend . Leag...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    2  (CNN)French striker Bafetimbi Gomis, who has a...  Bafetimbi Gomis collapses within 10 minutes of...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    3  (CNN)My vote for Father of the Year goes to Cu...  Ruben Navarrette: Schilling deserves praise fo...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    4  (CNN)It was an act of frustration perhaps more...  Rory McIlroy throws club into water at WGC Cad...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Word length analysis:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                source        target</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    count  13368.000000  13368.000000</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    mean     676.026406     57.910084</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    std      343.557667     25.613557</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    min       41.000000     10.000000</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    25%      413.750000     41.000000</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    50%      608.000000     54.000000</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    75%      868.000000     69.000000</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    max     1917.000000   1440.000000</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="6-train"></a>6. Train<a class="hash-link" href="#6-train" title="Direct link to heading">#</a></h2><p>The 75 percentile length for source text is 877 and 60 for target text. The sequence length after tokenization will also increase further. BART was pretrained with positional embedding upto 1024. We will use 1024 length for source and 128 for target. This value can be tuned further for better performance.</p><p><code>config.yaml</code> contains code which runs only for few steps to check if everything is OK. Run it to verify the correctness of the code and test the environment setup. This can also be run with CPU to do sanity test before moving code to GPU or running in AML.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="train-for-few-more-steps"></a>Train for few more steps<a class="hash-link" href="#train-for-few-more-steps" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ python data.py ~/cnn_cln # skip if ran previously</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ python train.py --data_path ~/cnn_cln</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ python train.py --data_path ~/cnn_cln --tmgr.max_train_steps_per_epoch 20 --tmgr.max_val_steps_per_epoch 20 --tmgr.epochs 3</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="run-production-config"></a>Run production config<a class="hash-link" href="#run-production-config" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="full-training-on-single-gpu"></a>Full training on single GPU<a class="hash-link" href="#full-training-on-single-gpu" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">python train.py --config_path config-prod.yaml --data_path ~/cnn_cln --dist False</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>This will be really slow though. Use PyMarlin&#x27;s distributed trainer to speed up training</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="7-distributed-training"></a>7. Distributed Training<a class="hash-link" href="#7-distributed-training" title="Direct link to heading">#</a></h2><p>Test config</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">python -m torch.distributed.launch --nproc_per_node 4 train.py --data_path ~/cnn_cln --dist</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Prod config</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">nohup python -m torch.distributed.launch --nproc_per_node 4 train.py --config_path config-prod.yaml --data_path ~/cnn_cln --dist &amp;&gt; prod-logs-dist.txt</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">tail -f  prod-logs-dist.txt</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p><em>Command to Kill all processes</em></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">ps |grep python | awk &#x27;{print $1}&#x27; | xargs -I% kill -9 %</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="8-start-tensorboard-in-vm"></a>8. Start tensorboard in VM<a class="hash-link" href="#8-start-tensorboard-in-vm" title="Direct link to heading">#</a></h2><p>In a separate shell,</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ tensorboard --logdir ~/PyMarlin/bart/logs.</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Tunnel tensorboard in local machine</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain"># ssh -N -f -L 127.0.0.1:6006:127.0.0.1:6006  $user@${machine} -p $port</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Now open tensorboard: http://localhost:6006/#scalars
<img alt="tensorboard screenshot" src="/PyMarlin/assets/images/tensorboard_screenshot_bart-d573a18768da7ece0adb108f272ac5d7.jpg"></p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/microsoft/PyMarlin/edit/master/website/docs/examples/bart.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-label="Edit page"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/PyMarlin/docs/examples/azureml"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Azure ML</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/PyMarlin/docs/examples/cifar"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">CIFAR image classification Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-download-data" class="table-of-contents__link">1. Download Data</a></li><li><a href="#2-preprocess-and-analyze" class="table-of-contents__link">2. Preprocess and analyze</a></li><li><a href="#3-train" class="table-of-contents__link">3. Train</a></li><li><a href="#1-setup-vm-environment" class="table-of-contents__link">1. Setup VM environment</a></li><li><a href="#2-transfer-code-form-local-machine-to-vm" class="table-of-contents__link">2. Transfer code form local machine to VM</a></li><li><a href="#3-install-pymarlin-and-requirements" class="table-of-contents__link">3. Install pymarlin and requirements</a></li><li><a href="#4-downlaod-data" class="table-of-contents__link">4. Downlaod data</a></li><li><a href="#5-analyze-data" class="table-of-contents__link">5. Analyze Data</a></li><li><a href="#6-train" class="table-of-contents__link">6. Train</a><ul><li><a href="#train-for-few-more-steps" class="table-of-contents__link">Train for few more steps</a></li><li><a href="#run-production-config" class="table-of-contents__link">Run production config</a></li></ul></li><li><a href="#7-distributed-training" class="table-of-contents__link">7. Distributed Training</a></li><li><a href="#8-start-tensorboard-in-vm" class="table-of-contents__link">8. Start tensorboard in VM</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/PyMarlin/docs/getting-started">Getting Started</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/pymarlin" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a href="https://github.com/microsoft/PyMarlin" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 Microsoft Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/PyMarlin/assets/js/runtime~main.7ee5d68a.js"></script>
<script src="/PyMarlin/assets/js/main.412c625a.js"></script>
</body>
</html>